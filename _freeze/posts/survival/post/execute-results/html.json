{
  "hash": "03333d517be8a06ae57d3239aed720b1",
  "result": {
    "markdown": "---\ntitle: \"Enhancing Survival Analysis in R with Custom Functions\"\ndate: \"2024-07-19\"\ncategories: ['R', 'survival analysis', 'kaplan-meier plot', 'log-rank test', 'data visualization', 'ggplot2']\ndescription: \"A step-by-step guide on how to steamline Survival Analysis in R with custom functions.\"\nexecute: \n  message: false\n  warning: false\neditor_options: \n  chunk_output_type: console\nformat: \n  html\neditor: \n  markdown: \n    wrap: sentence\n---\n\n\n# Introduction\n\nSurvival analysis is a critical aspect of statistical research, particularly in medical studies where time-to-event data, such as patient survival times, are analyzed.\nThe primary goal is to understand and visualize the survival probability over time, often comparing different groups.\n\nWhile R provides robust packages for survival analysis, automating and simplifying these tasks through custom functions can save time and reduce errors.\nThis blog post introduces a set of custom functions in R designed to streamline survival analysis, from fitting survival models to plotting Kaplan-Meier curves with p-values.\n\n## Introduction to the Code\n\nThe R code presented here comprises a series of custom functions that facilitate the steps involved in survival analysis.\nThe functions leverage libraries like `tidyverse`, `survival`, `ggfortify`, and `scales`.\nHere's a breakdown of what each function does:\n\n## Loading Necessary Libraries\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(survival)\nlibrary(ggfortify)\nlibrary(scales)\n```\n:::\n\n\nThese libraries are essential for data manipulation (`tidyverse`), survival analysis (`survival`), plotting (`ggfortify`), and formatting scales in plots (`scales`).\n\n## Custom Functions for Survival Analysis\n\n### 1. Fitting a Survival Object: `get_survival_analysis`\n\nThis function fits a survival object using the `survfit` function from the `survival` package.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_survival_analysis <- function(time, event, group, data){\n  params <- list(\n    time = substitute(time),\n    event = substitute(event),\n    group = substitute(group),\n    data = substitute(data)\n  )\n  expr <- substitute(survfit(Surv(time, event) ~ group, data = data), params)\n  eval.parent(expr)\n}\n```\n:::\n\n\n**Explanation:**\n\n-   **Purpose:** Fits a survival model to the data.\n\n-   **Parameters:** `time` (time to event), `event` (event status), `group` (grouping variable), `data` (dataset).\n\n-   **Functionality:** Creates a survival object by substituting the parameters into the `survfit` function and evaluating it in the parent environment.\n\n### 2. Obtaining p-values from Log-Rank Test: `get_p_log_rank`\n\nThis function performs a log-rank test to compare survival curves between groups.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_p_log_rank <- function(time, event, group, data){\n  params <- list(\n    time = substitute(time),\n    event = substitute(event),\n    group = substitute(group),\n    data = substitute(data)\n  )\n  expr <- substitute(survdiff(Surv(time, event) ~ group, data = data), params)\n  eval.parent(expr)$pvalue\n}\n```\n:::\n\n\n**Explanation:**\n\n-   **Purpose:** Obtains the p-value from a log-rank test.\n\n-   **Parameters:** Same as `get_survival_analysis`.\n\n-   **Functionality:** Substitutes the parameters into the `survdiff` function to perform the log-rank test and extracts the p-value.\n\n### 3. Rounding p-values: `round_p`\n\nThis utility function rounds p-values to three decimal places.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nround_p <- function(p){\n  format(round(p, 3), nsmall = 3)\n}\n```\n:::\n\n\n### 4. Creating Kaplan-Meier Plots with p-values: `make_kaplan_meier`\n\nThis function creates a Kaplan-Meier plot with an annotated p-value.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmake_kaplan_meier <- function(surv_object, p_value, xcoord, ycoord = 1, fun = NULL){\n  autoplot(surv_object, conf.int = FALSE, fun = fun) +\n    annotate(\n      geom = \"text\", x = xcoord, y = ycoord,\n      label = str_c(\"p-value: \", round_p(p_value))\n    ) +\n    scale_y_continuous(labels = label_percent(), limits = c(0, 1)) +\n    theme_classic() +\n    labs(\n      x = \"Follow-up time (days)\",\n      color = \"Group\"\n    )\n}\n```\n:::\n\n\n**Explanation:**\n\n-   **Purpose:** Draws a Kaplan-Meier survival curve with the p-value annotation.\n\n-   **Parameters:** `surv_object` (survival object), `p_value` (p-value from log-rank test), `xcoord` (x-coordinate for annotation), `ycoord` (y-coordinate for annotation), `fun` (optional transformation function for survival probabilities).\n\n-   **Functionality:** Uses `autoplot` to create the plot, adds a p-value annotation, and customizes the plot's appearance.\n\n### 5. Performing Comprehensive Survival Analysis: `make_survival_analysis`\n\nThis function integrates all the above steps into a single workflow.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmake_survival_analysis <- function(time, event, group, data, xcoord, ycoord = 1, fun = NULL){\n  params <- list(\n    time = substitute(time),\n    event = substitute(event),\n    group = substitute(group),\n    data = substitute(data)\n  )\n  expr <- substitute(get_survival_analysis(time, event, group, data), params)\n  surv_fit <- eval.parent(expr)\n  \n  expr <- substitute(get_p_log_rank(time, event, group, data), params)\n  p_value <- eval.parent(expr)\n  \n  make_kaplan_meier(surv_fit, p_value, xcoord, ycoord, fun)\n}\n```\n:::\n\n\n**Explanation:**\n\n-   **Purpose:** Performs the complete survival analysis, including model fitting, p-value calculation, and plotting.\n\n-   **Parameters:** Same as `get_survival_analysis` with additional plotting coordinates and transformation function.\n\n-   **Functionality:** Combines the steps of fitting the survival model, performing the log-rank test, and generating the Kaplan-Meier plot.\n\n## Applying the Functions\n\nHere's an example of how to use the `make_survival_analysis` function with the `lung` dataset from the `survival` package:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmake_survival_analysis(time = time, event = status, group = sex, data = lung, xcoord = 900) +\n  labs(y = \"Survival Probability\", title = \"Lung Cancer Survival by Sex\") +\n  scale_color_manual(values = 1:2, labels = c(\"Male\", \"Female\"))\n```\n\n::: {.cell-output-display}\n![](post_files/figure-html/example-plot-1.png){width=672}\n:::\n:::\n\n\nThis code performs the survival analysis on the `lung` dataset, comparing survival times between males and females, and plots the Kaplan-Meier curves with the corresponding p-value.\n\n# Conclusion\n\nBy encapsulating the steps of survival analysis into custom functions, we can efficiently conduct and visualize survival studies.\nThese functions not only streamline the workflow but also ensure consistency and reproducibility in survival analysis tasks.\nWhether you're comparing treatment groups or exploring survival probabilities in different cohorts, these tools can significantly enhance your analytical capabilities in R.\n\n# References\n\n-   Therneau T (2024). *A Package for Survival Analysis in R*. R package version 3.6-4, <https://CRAN.R-project.org/package=survival>.\n-   Terry M. Therneau, Patricia M. Grambsch (2000). *Modeling Survival Data: Extending the Cox Model*. Springer, New York. ISBN 0-387-98784-3.\n-   Wickham H, Averick M, Bryan J, Chang W, McGowan LD, François R, Grolemund G, Hayes A, Henry L, Hester J, Kuhn M, Pedersen TL, Miller E, Bache SM, Müller K, Ooms J, Robinson D, Seidel DP, Spinu V, Takahashi K, Vaughan D, Wilke C, Woo K, Yutani H (2019). “Welcome to the tidyverse.” *Journal of Open Source Software*, *4*(43), 1686. doi:10.21105/joss.01686 <https://doi.org/10.21105/joss.01686>.\n-   Yuan Tang, Masaaki Horikoshi, and Wenxuan Li. \"ggfortify: Unified Interface to Visualize Statistical Result of Popular R Packages.\" The R Journal 8.2 (2016): 478-489.\n-   Masaaki Horikoshi and Yuan Tang (2016). ggfortify: Data Visualization Tools for Statistical Analysis Results. https://CRAN.R-project.org/package=ggfortify\n-   Wickham H, Pedersen T, Seidel D (2023). *scales: Scale Functions for Visualization*. R package version 1.3.0, <https://CRAN.R-project.org/package=scales>.\n",
    "supporting": [
      "post_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}